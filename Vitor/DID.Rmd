---
title: "DID NSF"
author: "Vitor"
date: "7/17/2023"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
rm(list=ls())  

# Install packages
PackageNames <- c("did", "stargazer", "magrittr", "AER", "car", "lmtest", "plm", "skedastic", "dplyr")
for(i in PackageNames){
  if(!require(i, character.only = T)){
    install.packages(i, dependencies = T)
    require(i, character.only = T)
  }
}

# Read the dataset based on the machine or server
if (Sys.info()["user"] == "success" && Sys.info()["nodename"] == "LAPTOP-GAME") {
  # Your machine
  data_file <- "panel.csv"
} else if (Sys.info()["user"] == "Jason fill this fields" && Sys.info()["nodename"] == "ProfessorMachineHostname") {
  # Professor's machine
  data_file <- "path_to_professor_data_file.csv"
} else {
  # Server
  data_file <- "path_to_server_data_file.csv"
}

# Load the dataset
dta <- read.csv(data_file)

# Perform your data analysis using the 'data' variable

# Rest of your code...


```

Just testing
```{r}
data(mpdta)
```
Just testing


Creating a subset according to what aqnalysis you want (SBIR as example)
```{r}
SBIR <- dta %>%
  group_by(ID) %>%
  filter(any(SBIR_1 != 0))

# View the subset
print(SBIR)

```

## Most simple call
```{r}
# estimate group-time average treatment effects using att_gt method
example_attgt <- att_gt(yname = "SBIR_2",
                        tname = "Year_date",
                        idname = "ID",
                        gname = "g_SBIR_1",
                        xformla = ~1,
                        panel = FALSE,
                        data = dta
                        )

# provides estimates of the group-time average treatment effects in the column labeled att
summary(example_attgt)
```

# Aggregating group-time average treatment effects

This is the simple weighted average of all groups based on their size
```{r}
agg.simple <- aggte(example_attgt, type = "simple", na.rm = TRUE)
summary(agg.simple)
```

## Dynamic Effects and Event Studies 
```{r}
agg.es <- aggte(example_attgt, type = "dynamic", na.rm = TRUE)
summary(agg.es)
ggdid(agg.es)
```

## Group Effects and Event Studies 
```{r}
agg.g <- aggte(example_attgt, type = "group")
summary(agg.g)
ggdid(agg.g)
```

## aggregations across different time periods.
```{r}
agg.ct <- aggte(example_attgt, type = "calendar")
summary(agg.ct)
ggdid(agg.ct)
```

## Not Yet Treated 
```{r}
example_attgt_altcontrol <- att_gt(yname = "SBIR_2",
                                   tname = "Year_date",
                                   idname = "ID",
                                   gname = "g_SBIR_2",
                                   xformla = ~1,
                                   data = dta,
                                   allow_unbalanced_panel = TRUE,
                                   control_group = "notyettreated"          
                                   )
summary(example_attgt_altcontrol)
```
```{r}
agg.altcontrol <- aggte(example_attgt_altcontrol, type = "simple", na.rm = TRUE)
summary(agg.altcontrol)
```
## Dynamic Effects and Event Studies 
```{r}
agg.DS <- aggte(agg.altcontrol, type = "dynamic", na.rm = TRUE)
summary(agg.DS)
ggdid(agg.DS)
```




# END!!!!!!!!!!!!



# Not complete! Don't run.

I(total_corps*total_corps) +
```{r}
DID_simple <- plm(total_corps ~ df_others + df_PFI + df_SBIR_1 +df_SBIR_2 + df_STTR_1 + df_STTR_2 , data = data, model = "within", effect = "individual")

summary(DID_simple)

```


## Staggered difference-in-differences (Sun and Abraham, 2020)
```{r}
# To implement the Sun and Abraham (2020) method,
# we use the sunab(cohort, period) function
res_sa20 = feols(vc_sum ~  sunab(year_treated, year) + GDP_per| MSA + year, news_MSA_VC) # specifying the cluster here doesn't change anything
summary(res_sa20, vcov = "twoway")
```
## fixed-effects
```{r}
est_comb = feols(num_comp_per_aggreg~ MSA | treated^year_treated, news_MSA_VC )
summary(est_comb, vcov = "twoway")
#fixef(est_comb)[[1]]
```
## TWFE
```{r}
# "Naive" TWFE DiD (note that the time to treatment for the never treated is -1000)
# (by using ref = c(-1, -1000) we exclude the period just before the treatment and 
# the never treated)

res_twfe = feols(num_comp_per_aggreg ~  i(years_to_treat, ref = c(-1, -1000)) | MSA + year, news_MSA_VC)
summary(res_twfe, vcov = "twoway")
```
## Staggered difference-in-differences (Sun and Abraham, 2020)
```{r}
# To implement the Sun and Abraham (2020) method,
# we use the sunab(cohort, period) function
res_sa20 = feols(num_comp_per_aggreg ~  sunab(year_treated, year) | MSA + year, cluster = ~MSA, news_MSA_VC)
summary(res_sa20, vcov = "twoway")
```
### Plot
```{r}
# Plot the two TWFE results
iplot(list(res_twfe, res_sa20), sep = 0.5)
```
```{r}
summary(res_sa20, agg = "att")
```

### heteroskedasticity?
```{r}
bptest(fit.vot)
```




